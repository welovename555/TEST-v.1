<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Analytics Dashboard</title>
  <meta name="description" content="เว็บแอปพลิเคชันวิเคราะห์ข้อมูลการขาย - Dashboard แบบ Mobile-First พร้อมกราฟ Interactive" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --surface:#11162a;
      --surface-2:#0d1326;
      --text:#e6eaf2;
      --muted:#9aa4b2;
      --primary:#5b8cff;
      --primary-2:#7ca4ff;
      --accent:#22d1ee;
      --success:#26d07c;
      --danger:#ff647c;
      --warning:#ffcc66;
      --card-radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f7f8fb;
      --surface:#ffffff;
      --surface-2:#f0f3fa;
      --text:#0e1320;
      --muted:#5b6472;
      --primary:#3b6cff;
      --primary-2:#5e83ff;
      --accent:#0fbad6;
      --success:#15b86a;
      --danger:#e84f67;
      --warning:#e5b23b;
      --shadow:0 10px 25px rgba(16,28,77,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;
      background:linear-gradient(180deg, var(--bg), var(--surface-2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .app{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
    }
    header.appbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(1.4) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0))
                 ,var(--surface-2);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .appbar .wrap{
      max-width:1200px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    }
    .title{
      display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;letter-spacing:.2px;
    }
    .title .logo{
      width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));
      box-shadow:0 6px 18px rgba(34,209,238,.25);display:grid;place-items:center;color:white;font-weight:800;
    }

    .grow{flex:1}

    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;background:var(--surface);
      color:var(--text);box-shadow:var(--shadow);cursor:pointer;font-weight:600;transition:.25s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.2)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(127, 139, 172, .35)}

    .date-range{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:12px;background:var(--surface);box-shadow:var(--shadow)}
    .date-range input{background:transparent;border:none;color:var(--text);padding:8px;border-radius:8px;outline:none;font-weight:600}
    .date-range label{font-size:12px;color:var(--muted)}

    .theme-toggle{display:flex;align-items:center;gap:8px}
    .switch{position:relative;width:50px;height:28px;background:var(--surface);border-radius:999px;cursor:pointer;border:1px solid rgba(127,139,172,.35)}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));transition:.25s}
    .switch.active::after{left:25px}

    main{max-width:1200px;margin:16px auto;padding:0 16px 28px;display:grid;gap:14px}

    /* Summary cards */
    .grid{display:grid;gap:14px}
    .cards{grid-template-columns:repeat(2,1fr)}
    @media(min-width:720px){.cards{grid-template-columns:repeat(4,1fr)}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)), var(--surface);
      border:1px solid rgba(127,139,172,.2);
      border-radius:var(--card-radius);
      box-shadow:var(--shadow);
      padding:16px;position:relative;overflow:hidden
    }
    .card .label{color:var(--muted);font-size:12px}
    .card .value{font-weight:800;font-size:22px;margin-top:6px}
    .trend{display:flex;align-items:center;gap:6px;font-size:12px;margin-top:8px}
    .trend.up{color:var(--success)}
    .trend.down{color:var(--danger)}

    /* Panels */
    .panel{display:grid;gap:12px}
    .panel header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .panel header h3{margin:0;font-size:16px}
    .panel .actions{display:flex;gap:8px;flex-wrap:wrap}

    .chart-card{height:320px}
    .chart{width:100%;height:100%}

    /* Top products list */
    .top-list{display:grid;gap:10px}
    .top-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:var(--surface-2);border:1px solid rgba(127,139,172,.2)}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(91,140,255,.15);color:var(--primary)}

    /* Heatmap legend */
    .legend{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
    .legend .box{width:16px;height:10px;border-radius:3px;background:var(--surface-2);border:1px solid rgba(127,139,172,.2)}

    /* Loading shimmer */
    .shimmer{position:relative;overflow:hidden}
    .shimmer::after{content:"";position:absolute;inset:0;transform:translateX(-100%);
      background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.12) 50%, transparent 100%);
      animation:shimmer 1.4s infinite;
    }
    @keyframes shimmer{100%{transform:translateX(100%)}}

    /* Animations */
    .fade-up{opacity:0;transform:translateY(8px);animation:fadeUp .5s ease forwards}
    @keyframes fadeUp{to{opacity:1;transform:none}}

    footer{opacity:.7;font-size:12px;text-align:center;padding:24px}
    a{color:var(--primary)}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="appbar">
      <div class="wrap">
        <div class="title">
          <div class="logo">SA</div>
          <div>Sales Analytics Dashboard</div>
        </div>
        <div class="grow"></div>
        <div class="controls">
          <div class="date-range" aria-label="ช่วงวันที่">
            <label for="start">เริ่ม</label>
            <input type="date" id="start" />
            <label for="end">ถึง</label>
            <input type="date" id="end" />
          </div>
          <button class="btn ghost" data-range="7">7 วัน</button>
          <button class="btn ghost" data-range="30">30 วัน</button>
          <button class="btn primary" id="apply">อัปเดต</button>
          <div class="theme-toggle">
            <div style="font-size:12px;color:var(--muted)">ธีม</div>
            <div class="switch" id="themeSwitch" role="switch" aria-label="สลับธีม"></div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="grid cards">
        <div class="card fade-up" style="animation-delay:.05s">
          <div class="label">ยอดขายรวม (ชิ้น)</div>
          <div class="value" id="metric-total-units">—</div>
          <div class="trend" id="metric-total-units-trend"></div>
        </div>
        <div class="card fade-up" style="animation-delay:.1s">
          <div class="label">จำนวนออเดอร์</div>
          <div class="value" id="metric-orders">—</div>
          <div class="trend" id="metric-orders-trend"></div>
        </div>
        <div class="card fade-up" style="animation-delay:.15s">
          <div class="label">จำนวนลูกค้า</div>
          <div class="value" id="metric-customers">—</div>
          <div class="trend" id="metric-customers-trend"></div>
        </div>
        <div class="card fade-up" style="animation-delay:.2s">
          <div class="label">ชั่วโมงที่พีคที่สุด</div>
          <div class="value" id="metric-peak-time">—</div>
          <div class="trend" id="metric-peak-day"></div>
        </div>
      </section>

      <section class="grid" style="grid-template-columns:1fr;gap:14px">
        <!-- Top selling products -->
        <div class="card panel chart-card fade-up" style="animation-delay:.25s">
          <header>
            <h3>สินค้าขายดี (Top-selling)</h3>
            <div class="actions">
              <select id="topN" class="btn ghost" aria-label="จำนวนอันดับ">
                <option value="5">Top 5</option>
                <option value="10">Top 10</option>
                <option value="15">Top 15</option>
              </select>
            </div>
          </header>
          <div class="chart" id="chart-top"></div>
          <div class="top-list" id="top-list" style="margin-top:10px"></div>
        </div>

        <!-- Daily sales per product -->
        <div class="card panel chart-card fade-up" style="animation-delay:.3s">
          <header>
            <h3>ยอดขายรายวันแยกตามสินค้า (ชิ้นต่อวัน)</h3>
            <div class="actions">
              <label class="btn ghost" style="display:flex;gap:6px;align-items:center">
                <span>สินค้า</span>
                <select id="productSelect" style="background:transparent;color:var(--text);border:none;outline:none">
                  <option value="__TOP5__">Top 5</option>
                  <option value="__ALL__">ทั้งหมด (สรุป)</option>
                </select>
              </label>
            </div>
          </header>
          <div class="chart" id="chart-daily"></div>
        </div>

        <!-- Peak time heatmap -->
        <div class="card panel chart-card fade-up" style="animation-delay:.35s">
          <header>
            <h3>ช่วงเวลาพีค/ต่ำสุด (รายวัน/รายสัปดาห์)</h3>
            <div class="actions legend">
              <span class="box" style="background:#20304a"></span> ต่ำ
              <span class="box" style="background:#5b8cff"></span> กลาง
              <span class="box" style="background:#22d1ee"></span> สูง
            </div>
          </header>
          <div class="chart" id="chart-heatmap"></div>
        </div>

        <!-- Customer trend -->
        <div class="card panel chart-card fade-up" style="animation-delay:.4s">
          <header>
            <h3>แนวโน้มจำนวนลูกค้า</h3>
            <div class="actions"></div>
          </header>
          <div class="chart" id="chart-customers"></div>
        </div>
      </section>
    </main>

    <footer>
      Sales Analytics Dashboard • Mobile-First • Interactive Charts • UI/UX ทันสมัย
    </footer>
  </div>

  <!-- ECharts CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- Day.js (lightweight date lib) -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Bangkok';

    // ===== Config: Supabase (set useMock=true to simulate data) =====
    const SUPABASE_URL = 'https://jkenfjjxwdckmvqjkdkp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZW5mamp4d2Rja212cWprZGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MjA5NjIsImV4cCI6MjA2NjM5Njk2Mn0.3VOZpt4baNnC5-qpYq6dC9UZ0gcfI2V4aTdi1itxmXI';
    const sb = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
    const useMock = false; // ใช้ฐานข้อ��ูลจริงผ่าน Supabase

    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const fmt = (n) => new Intl.NumberFormat('th-TH').format(n);

    // Theme handling
    const theme = {
      get current(){ return document.documentElement.getAttribute('data-theme') || 'dark' },
      toggle(){ const t = this.current === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', t); $('#themeSwitch').classList.toggle('active', t==='light'); charts.renderAll(); }
    };

    // ===== Mock Data Generator =====
    const mock = {
      products:[
        {id:'P01', name:'กาแฟคาปูชิโน่'},
        {id:'P02', name:'ลาเต้'},
        {id:'P03', name:'อเมริกาโน่'},
        {id:'P04', name:'ชาเขียวมัทฉะ'},
        {id:'P05', name:'โกโก้เข้มข้น'},
        {id:'P06', name:'ชานมไข่มุก'},
        {id:'P07', name:'น้ำส้มคั้นสด'},
        {id:'P08', name:'สมูทตี้ผลไม้รวม'},
      ],
      price:{P01:70,P02:75,P03:65,P04:85,P05:80,P06:60,P07:55,P08:90},
      randomCustomer(i){ return 'C' + (1000 + Math.floor(Math.random()*3000)); },
      generate(start, end){
        const records = [];
        const startD = dayjs(start).startOf('day');
        const endD = dayjs(end).endOf('day');
        for(let d = startD; d.isBefore(endD); d = d.add(1,'day')){
          const base = 40 + Math.floor(Math.random()*40); // orders/day
          for(let i=0;i<base;i++){
            const hourBias = [7,8,9,10,11,12,13,14,15,16,17,18];
            const h = hourBias[Math.floor(Math.random()*hourBias.length)];
            const m = Math.floor(Math.random()*60);
            const ts = d.hour(h).minute(m).second(Math.floor(Math.random()*60));
            const p = this.products[Math.floor(Math.random()*this.products.length)];
            const qty = 1 + (Math.random()<.2 ? 1 : 0) + (Math.random()<.07 ? 1 : 0);
            records.push({
              id:'S'+Math.random().toString(36).slice(2),
              timestamp: ts.toDate().toISOString(),
              productId: p.id,
              productName: p.name,
              quantity: qty,
              amount: qty * (this.price[p.id]||60),
              customerId: this.randomCustomer()
            });
          }
        }
        return { sales: records };
      }
    };

    // ===== Data Access Layer =====
    async function fetchSalesData(startISO, endISO){
      if(useMock){
        // Simulate latency
        await new Promise(r=>setTimeout(r, 300));
        return mock.generate(startISO, endISO);
      }
      if(!sb) throw new Error('Supabase client not initialized');
      const start = dayjs(startISO).startOf('day').toISOString();
      const end = dayjs(endISO).endOf('day').toISOString();

      // 1) Load sales within range
      const { data: salesRows, error: salesErr } = await sb
        .from('sales')
        .select('created_at, product_id, quantity, price_per_unit, total_item_price, transaction_id')
        .gte('created_at', start)
        .lte('created_at', end)
        .order('created_at', { ascending: true })
        .limit(10000);
      if(salesErr) throw salesErr;

      // 2) Load product names for involved product_ids
      const productIds = [...new Set((salesRows||[]).map(r=>r.product_id).filter(Boolean))];
      let namesMap = new Map();
      if(productIds.length){
        const { data: prods, error: prodErr } = await sb
          .from('products')
          .select('id, name')
          .in('id', productIds);
        if(prodErr) throw prodErr;
        namesMap = new Map((prods||[]).map(p=>[p.id, p.name]));
      }

      const sales = (salesRows||[]).map(r => ({
        timestamp: r.created_at,
        productId: r.product_id,
        productName: namesMap.get(r.product_id) || r.product_id,
        quantity: r.quantity,
        amount: Number(r.total_item_price ?? (Number(r.price_per_unit) * r.quantity)),
        customerId: r.transaction_id // proxy: ใช้รหัสธุรกรรมแทนลูกค้า
      }));
      return { sales };
    }

    // ===== Aggregation Helpers =====
    function rangeDays(start, end){
      const days = []; let d = dayjs(start).startOf('day'); const e = dayjs(end).startOf('day');
      while(d.isSame(e) || d.isBefore(e)){ days.push(d); d = d.add(1,'day'); }
      return days;
    }

    function aggregate(data, start, end){
      const sales = data.sales || [];
      const byProductTotals = new Map();
      const byDateProduct = new Map(); // key: date|productId -> qty
      const customersByDay = new Map(); // date -> Set(customerId)
      const heatmap = Array.from({length:7}, ()=> Array(24).fill(0)); // dow(0-6) x hour(0-23)
      let orders = 0, totalUnits = 0;

      for(const s of sales){
        const d = dayjs(s.timestamp).tz(tz);
        const dateKey = d.format('YYYY-MM-DD');
        orders += 1; totalUnits += s.quantity;
        byProductTotals.set(s.productId, (byProductTotals.get(s.productId)||0) + s.quantity);
        const dpk = dateKey + '|' + s.productId;
        byDateProduct.set(dpk, (byDateProduct.get(dpk)||0) + s.quantity);
        if(!customersByDay.has(dateKey)) customersByDay.set(dateKey, new Set());
        customersByDay.get(dateKey).add(s.customerId);
        heatmap[d.day()][d.hour()] += s.quantity;
      }

      const days = rangeDays(start, end);
      const customersSeries = days.map(d=>customersByDay.get(d.format('YYYY-MM-DD'))?.size||0);

      const topProducts = [...byProductTotals.entries()].sort((a,b)=>b[1]-a[1]);

      const dailySeriesByProduct = new Map();
      for(const [pid] of topProducts){
        dailySeriesByProduct.set(pid, days.map(d=>byDateProduct.get(d.format('YYYY-MM-DD')+'|'+pid)||0));
      }

      // Peak analysis
      let peak = { value:-Infinity, day:0, hour:0 };
      let low = { value:Infinity, day:0, hour:0 };
      for(let dow=0; dow<7; dow++){
        for(let h=0; h<24; h++){
          const v = heatmap[dow][h];
          if(v>peak.value) peak = {value:v, day:dow, hour:h};
          if(v<low.value) low = {value:v, day:dow, hour:h};
        }
      }

      return {
        orders, totalUnits, days, topProducts, dailySeriesByProduct, customersSeries, heatmap, peak, low
      };
    }

    // ===== Charts =====
    const charts = (function(){
      let topChart, dailyChart, heatChart, custChart;

      function baseTextColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#e6eaf2'; }
      function baseMutedColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#9aa4b2'; }
      function color(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

      function renderTopSelling(container, data, topN){
        const labels = [], values = [];
        const items = data.topProducts.slice(0, topN);
        for(const [pid, qty] of items){
          const name = (window.__latest?.productNames?.get(pid)) || pid;
          labels.push(name); values.push(qty);
        }
        const opt = {
          grid:{left:10,right:10,top:20,bottom:0,containLabel:true},
          xAxis:{ type:'value', axisLabel:{color:baseMutedColor()} },
          yAxis:{ type:'category', data:labels, axisLabel:{color:baseTextColor()} },
          series:[{ type:'bar', data:values, barWidth:14,
            itemStyle:{
              borderRadius:[0,8,8,0],
              color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:color('--primary')},{offset:1,color:color('--accent')}])
            },
            label:{show:true, position:'right', color:baseTextColor()}
          }],
          tooltip:{trigger:'item'}
        };
        topChart = topChart || echarts.init(container);
        topChart.setOption(opt, true);
        window.addEventListener('resize', ()=> topChart && topChart.resize());
      }

      function renderTopList(container, data, topN){
        container.innerHTML = '';
        const items = data.topProducts.slice(0, topN);
        for(const [pid, qty] of items){
          const name = (window.__latest?.productNames?.get(pid)) || pid;
          const el = document.createElement('div');
          el.className = 'top-item';
          el.innerHTML = `<div style="display:flex;gap:10px;align-items:center">`+
                         `<div class="pill">${name}</div>`+
                         `</div>`+
                         `<div style="font-weight:700">${fmt(qty)} ชิ้น</div>`;
          container.appendChild(el);
        }
      }

      function renderDaily(container, data, selection){
        // selection: '__TOP5__' | '__ALL__' | productId
        const x = data.days.map(d=>d.format('DD MMM'));
        let series=[];
        if(selection==='__ALL__'){
          // single series of total per day
          const totalPerDay = data.days.map((d,i)=>{
            let sum = 0; for(const arr of data.dailySeriesByProduct.values()) sum += arr[i]; return sum;
          });
          series=[{ name:'รวม', type:'line', smooth:true, areaStyle:{}, symbol:'circle', data:totalPerDay,
            itemStyle:{color:color('--primary')}, lineStyle:{width:3} }];
        } else {
          const productIds = selection==='__TOP5__' ? data.topProducts.slice(0,5).map(([pid])=>pid) : [selection];
          const palette=[color('--primary'),color('--accent'),'#7ee787','#ef6fff','#ffaa33'];
          series = productIds.map((pid,idx)=>{
            const arr = data.dailySeriesByProduct.get(pid) || data.days.map(_=>0);
            const name = (window.__latest?.productNames?.get(pid)) || pid;
            return { name, type:'line', smooth:true, symbol:'circle', areaStyle:{opacity:.12}, data:arr,
              itemStyle:{color:palette[idx%palette.length]}, lineStyle:{width:3} };
          });
        }
        const opt = {
          legend:{textStyle:{color:baseTextColor()}},
          grid:{left:10,right:10,top:30,bottom:10,containLabel:true},
          tooltip:{trigger:'axis'},
          xAxis:{type:'category', data:x, axisLabel:{color:baseMutedColor()}},
          yAxis:{type:'value', axisLabel:{color:baseMutedColor()}},
          series
        };
        dailyChart = dailyChart || echarts.init(container);
        dailyChart.setOption(opt, true);
        window.addEventListener('resize', ()=> dailyChart && dailyChart.resize());
      }

      function renderHeatmap(container, data){
        // data.heatmap: [7][24]
        const hours = Array.from({length:24}, (_,i)=> i.toString().padStart(2,'0')+':00');
        const days = ['อา','จ','อ','พ','พฤ','ศ','ส'];
        const values = [];
        let max=0; let min=Infinity;
        for(let d=0; d<7; d++){
          for(let h=0; h<24; h++){
            const v = data.heatmap[d][h];
            values.push([h, d, v]);
            if(v>max) max=v; if(v<min) min=v;
          }
        }
        const opt = {
          tooltip:{position:'top'},
          grid:{left:50,right:20,top:20,bottom:20},
          xAxis:{type:'category', data:hours, splitArea:{show:true}, axisLabel:{color:baseMutedColor(), interval:2}},
          yAxis:{type:'category', data:days, splitArea:{show:true}, axisLabel:{color:baseMutedColor()}},
          visualMap:{min:min, max:max||1, calculable:true, orient:'horizontal', left:'center', bottom:0,
            inRange:{color:['#20304a','#5b8cff','#22d1ee']}, textStyle:{color:baseTextColor()} },
          series:[{
            name:'ปริมาณชิ้น', type:'heatmap', data:values,
            label:{show:false},
            emphasis:{itemStyle:{shadowBlur:10,shadowColor:'rgba(0,0,0,0.3)'}}
          }]
        };
        heatChart = heatChart || echarts.init(container);
        heatChart.setOption(opt, true);
        window.addEventListener('resize', ()=> heatChart && heatChart.resize());
      }

      function renderCustomers(container, data){
        const x = data.days.map(d=>d.format('DD MMM'));
        const opt = {
          grid:{left:10,right:10,top:20,bottom:10,containLabel:true},
          tooltip:{trigger:'axis'},
          xAxis:{type:'category', data:x, axisLabel:{color:baseMutedColor()}},
          yAxis:{type:'value', axisLabel:{color:baseMutedColor()}},
          series:[{ name:'ลูกค้า/วัน', type:'line', smooth:true, data:data.customersSeries,
            symbol:'circle', areaStyle:{opacity:.12}, itemStyle:{color:color('--success')}, lineStyle:{width:3} }]
        };
        custChart = custChart || echarts.init(container);
        custChart.setOption(opt, true);
        window.addEventListener('resize', ()=> custChart && custChart.resize());
      }

      function renderAll(){
        if(window.__latest){
          const { agg } = window.__latest;
          renderTopSelling($('#chart-top'), agg, parseInt($('#topN').value,10));
          renderTopList($('#top-list'), agg, parseInt($('#topN').value,10));
          renderDaily($('#chart-daily'), agg, $('#productSelect').value);
          renderHeatmap($('#chart-heatmap'), agg);
          renderCustomers($('#chart-customers'), agg);
        }
      }

      return { renderTopSelling, renderDaily, renderHeatmap, renderCustomers, renderTopList, renderAll };
    })();

    // ===== App Logic =====
    async function loadAndRender(){
      const start = $('#start').value || dayjs().subtract(29,'day').format('YYYY-MM-DD');
      const end = $('#end').value || dayjs().format('YYYY-MM-DD');
      // Save back defaulted values for UX
      $('#start').value = start; $('#end').value = end;

      // Show loading shimmer
      for(const id of ['#chart-top','#chart-daily','#chart-heatmap','#chart-customers']){
        const el = $(id); el.classList.add('shimmer');
      }

      const raw = await fetchSalesData(start, end);
      const agg = aggregate(raw, start, end);

      // Update metrics
      $('#metric-total-units').textContent = fmt(agg.totalUnits);
      $('#metric-orders').textContent = fmt(agg.orders);
      const customerTotal = agg.customersSeries.reduce((a,b)=>a+b,0);
      $('#metric-customers').textContent = fmt(new Set(raw.sales.map(s=>s.customerId)).size);

      // Peak labels
      const dayNames = ['อาทิตย์','จันทร์','อังคาร','พุธ','พฤหัส','ศุกร์','เสาร์'];
      $('#metric-peak-time').textContent = `${agg.peak.hour.toString().padStart(2,'0')}:00`;
      $('#metric-peak-day').textContent = `พีคสุด: ${dayNames[agg.peak.day]} / ต่ำสุด: ${dayNames[agg.low.day]}`;

      // Trends (mocked vs previous period)
      const prevRaw = await fetchSalesData(dayjs(start).subtract( (dayjs(end).diff(dayjs(start),'day')+1) ,'day').format('YYYY-MM-DD'), dayjs(start).subtract(1,'day').format('YYYY-MM-DD'));
      const prevAgg = aggregate(prevRaw, dayjs(start).subtract( (dayjs(end).diff(dayjs(start),'day')+1) ,'day'), dayjs(start).subtract(1,'day'));
      function renderTrend(el, curr, prev){
        const diff = curr - prev; const pct = prev ? (diff/prev)*100 : 100;
        el.className = 'trend ' + (diff>=0 ? 'up' : 'down');
        el.innerHTML = `${diff>=0?'▲':'▼'} ${isFinite(pct)?pct.toFixed(1):'—'}% เทียบช่วงก่อนหน้า`;
      }
      renderTrend($('#metric-total-units-trend'), agg.totalUnits, prevAgg.totalUnits);
      renderTrend($('#metric-orders-trend'), agg.orders, prevAgg.orders);
      renderTrend($('#metric-customers-trend'), new Set(raw.sales.map(s=>s.customerId)).size, new Set(prevRaw.sales.map(s=>s.customerId)).size);

      // Render charts
      const productNames = new Map();
      raw.sales.forEach(s => { if (s.productId && s.productName) productNames.set(s.productId, s.productName); });
      window.__latest = { raw, agg, productNames };
      charts.renderTopSelling($('#chart-top'), agg, parseInt($('#topN').value,10));
      charts.renderTopList($('#top-list'), agg, parseInt($('#topN').value,10));
      charts.renderDaily($('#chart-daily'), agg, $('#productSelect').value);
      charts.renderHeatmap($('#chart-heatmap'), agg);
      charts.renderCustomers($('#chart-customers'), agg);

      // Remove shimmer
      for(const id of ['#chart-top','#chart-daily','#chart-heatmap','#chart-customers']){
        const el = $(id); el.classList.remove('shimmer');
      }
    }

    function initControls(){
      // Range quick buttons
      document.querySelectorAll('[data-range]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const days = parseInt(btn.getAttribute('data-range'),10);
          const end = dayjs().format('YYYY-MM-DD');
          const start = dayjs().subtract(days-1,'day').format('YYYY-MM-DD');
          $('#start').value = start; $('#end').value = end; loadAndRender();
        });
      });
      $('#apply').addEventListener('click', ()=> loadAndRender());
      $('#themeSwitch').addEventListener('click', ()=> theme.toggle());
      $('#topN').addEventListener('change', ()=> charts.renderAll());
      $('#productSelect').addEventListener('change', ()=> charts.renderAll());

      // Default theme: dark
      document.documentElement.setAttribute('data-theme','dark');
      $('#themeSwitch').classList.remove('active');
    }

    // ===== Boot =====
    window.addEventListener('DOMContentLoaded', async ()=>{
      initControls();
      // Default last 30 days
      $('#start').value = dayjs().subtract(29,'day').format('YYYY-MM-DD');
      $('#end').value = dayjs().format('YYYY-MM-DD');
      await loadAndRender();
    });
  </script>
</body>
</html>
